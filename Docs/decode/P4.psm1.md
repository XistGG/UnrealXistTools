# Decode: P4.psm1

**File**: `Modules/P4.psm1`

## Definition

This module provides extensive helper functions for interacting with Perforce (P4) CLI commands, parsing output, handling file path encoding, and managing common P4 operations.

### Exported Functions

| Function Name | Parameters | Description |
| :--- | :--- | :--- |
| `P4_DecodePath` | `[string]$Path` | Decodes a P4-encoded path (e.g., `%40` -> `@`). |
| `P4_EncodePath` | `[string]$Path` | Encodes a path for P4 CLI usage (e.g., `@` -> `%40`). |
| `P4_ParseFileType` | `[string]$TypeString` | Parses a P4 file type string (e.g., `text+w`) into a PSCustomObject with modifiers. |
| `P4_ParseChangeLine` | `[string]$Line`, `[switch]$ParseFileType` | Parses a line from `p4 opened` or `p4 describe` output (e.g., `//depot/file#1 - edit default change`). |
| `P4_FilterIgnoredPaths` | `[ArrayList]$Paths` | Splits a list of file paths into `ValidPaths` and `IgnoredPaths` based on `p4 ignores` rules. |
| `P4_GetPendingChangeLists` | `[string]$Workspace` | Returns a list of pending changelist numbers for the given workspace. |
| `P4_FStat` | `[ArrayList]$Paths` | Runs `p4 fstat` on a list of files and returns parsed results as an ArrayList of PSCustomObjects. |
| `P4_ParseSpecification` | `[ArrayList]$Content` | Parses the output of a P4 specification (like `p4 change -o`) into a PSCustomObject. |
| `P4_GetChange` | `[string]$CL` | Retrieves and parses a change specification (default CL or numbered CL). |
| `P4_Describe` | `[string]$CL` | Retrieves and parses the description of a submitted changelist using `p4 describe -s`. |
| `P4_StreamInfo` | `[string]$Stream` | Retrieves and parses the stream specification using `p4 stream -o`. |

## Usages

| File | Context |
| :--- | :--- |
| `[P4EncodePath.ps1](../../P4EncodePath.ps1)` | Demonstrates encoding/decoding paths. |
| `[P4FilterIgnored.ps1](../../P4FilterIgnored.ps1)` | Filters a list of files against `p4 ignores`. |
| `[P4ImportBulk.ps1](../../P4ImportBulk.ps1)` | Imports large numbers of files in batches, handling encoding and recovery. |
| `[P4ListIgnoredFiles.ps1](../../P4ListIgnoredFiles.ps1)` | Scans a directory for ignored files present on disk. |
| `[P4ObliterateIgnoredFiles.ps1](../../P4ObliterateIgnoredFiles.ps1)` | Obliterates files from P4 that should be ignored but were added. |
| `[P4Reunshelve.ps1](../../P4Reunshelve.ps1)` | Reverts local changes and unshelves a specific CL, useful for syncing test environments. |
| `[P4RemergeSidestream.ps1](../../P4RemergeSidestream.ps1)` | Merges changes from a side stream (e.g., a feature branch) into the current workspace. |
| `[P4LastGreenBuild.ps1](../../P4LastGreenBuild.ps1)` | Gets the stream info for a known "Green Build" stream. |
| `[P4FStat.ps1](../../P4FStat.ps1)` | CLI wrapper for `P4_FStat`. |
| `[P4AutoResolveToDefaultCL.ps1](../../P4AutoResolveToDefaultCL.ps1)` | Moves auto-resolvable files to the default changelist, leaving complex conflicts for manual resolution. |

## Invocation Details

### [P4FilterIgnored.ps1](../../P4FilterIgnored.ps1)

Used to filter a list of files against the ignore rules.

```powershell
    $result =& P4_FilterIgnoredPaths -Paths $Paths
```

### [P4ImportBulk.ps1](../../P4ImportBulk.ps1)

Uses `P4_DecodePath` to handle file paths from `p4 add` output, and `P4_GetChange` to check the default changelist state for recovery.

```powershell
        # Start by checking the value of the current default change...
        $initialChange = P4_GetChange
        if ($initialChange.Files -ne $null) { ... }

        # ...
        
        # `p4 add -m` writes filenames in an Encoded format, so we need to decode it
        $DecodedPath = P4_DecodePath $Path
```

### [P4AutoResolveToDefaultCL.ps1](../../P4AutoResolveToDefaultCL.ps1)

Uses `P4_FStat` heavily to check resolve status of files.

```powershell
    $fstatResult = & P4_FStat -Paths $script:IntegrateFiles
    
    foreach ($fstat in $fstatResult) {
        if ($fstat.unresolved -and -not $fstat.resolved) {
            # This file is marked as needing to be resolved
            $resolvePaths.Add($fstat.depotFile) > $null
        }
        # ...
    }
```

## Observations
- This module is central to all P4 automation in the workspace.
- It abstracts away the complexity of parsing P4's text-based output.
- It correctly handles P4's strict character encoding rules (e.g., `%40` for `@`), which is critical for filenames containing special characters.
- The `P4_FStat` function includes retry logic, making it robust against transient network issues or server load.
